name: build-chart
description: >
  Builds helm chart and pushes it to nesto's `charts` Google Artifacts Registry repo at:
  northamerica-northeast1-docker.pkg.dev/nesto-ci-78a3f2e6

inputs:

  name:
    description: Name of chart.
    required: true

  version:
    description: Version of chart.
    required: true

  key:
    description: >
        Key for service account to use for pushing charts (typically `secrets.GCP_KEY`).
        Generated by `global` pulumi project, which exposes it as `gitHubActionsSAKeyBase64` output
        (see: https://github.com/nestoca/infra/blob/47ccfe7e4c34d8fb9cb77a1620a07d8a4acc5099/pulumi/global/components/gcp/projects/cicd.ts#L176).
    required: true

  work-dir:
    description: Optional working directory to build chart from (defaults to '.').
    required: false
    default: .

  registry:
    description: Optional helm chart registry host name (defaults to 'northamerica-northeast1-docker.pkg.dev').
    required: false
    default: northamerica-northeast1-docker.pkg.dev
      
runs:
  using: composite
  steps:

    - id: "auth"
      uses: "google-github-actions/auth@v1"
      with:
        credentials_json: "${{ inputs.key }}"

    - name: Set up Google Cloud SDK
      uses: google-github-actions/setup-gcloud@v1.1.1
      with:
        project_id: nesto-ci-78a3f2e6
        install_components: docker-credential-gcr

    - name: Install helm
      shell: bash
      run: |-
        curl https://baltocdn.com/helm/signing.asc | sudo apt-key add -
        echo "deb https://baltocdn.com/helm/stable/debian/ all main" | sudo tee /etc/apt/sources.list.d/helm-stable-debian.list
        sudo apt-get update
        sudo apt-get install -y helm

    - name: Build and push Helm chart
      shell: bash
      run: |-
        cd "${{ inputs.work-dir }}"

        # Obtain and login using ephemeral access token
        gcloud auth application-default print-access-token | helm registry login -u oauth2accesstoken \
          --password-stdin https://${{ inputs.registry }} 1>&2

        # Patch Chart.yaml
        sed -i_ "s/name\: .+/name\: ${{ inputs.name }}/" Chart.yaml
        sed -i_ "s/version\: 9\.9\.9/version\: ${{ inputs.version }}/" Chart.yaml

        # Build and push
        TAR=${{ inputs.name }}-${{ inputs.version }}.tgz
        helm package --version ${{ inputs.version }} .
        HELM_EXPERIMENTAL_OCI=1 helm push $TAR oci://${{ inputs.registry }}/nesto-ci-78a3f2e6/charts

        # Clean-up
        cp Chart.yaml{_,}
        rm Chart.yaml_
        rm $TAR
