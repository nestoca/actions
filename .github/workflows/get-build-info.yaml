name: Build docker image for get-build-info action
on:
  push:
    branches:
      - master
    paths:
      - "get-build-info/docker/**"
concurrency:
  group: get-build-info
jobs:
  build:
    name: Build docker image
    runs-on: ubuntu-latest
    permissions:
      contents: "read"
      id-token: "write"
    steps:
      - name: Check-out
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          fetch-depth: 0
      - name: Get build info
        id: info
        uses: nestoca/actions/get-build-info@v1
        with:
          working-directory: get-build-info/docker
          project: get-build-info
          git-tag-prefix: get-build-info/docker/v
      - uses: RafikFarhad/push-to-gcr-github-action@v5-beta
        with:
          # Base-64 encoded JSON key of GCP service account to use for pushing image to Google Artifact Registry `actions` repo.
          # Generated by `global` pulumi project, which exposes it as `gitHubActionsSAKeyBase64` output (see:
          # https://github.com/nestoca/infra/blob/47ccfe7e4c34d8fb9cb77a1620a07d8a4acc5099/pulumi/global/components/gcp/projects/cicd.ts#L176).
          gcloud_service_key: ${{ secrets.GCP_KEY }}
          registry: northamerica-northeast1-docker.pkg.dev
          project_id: nesto-ci-78a3f2e6/actions
          image_name: get-build-info
          image_tag: ${{ steps.info.outputs.docker-tag }},latest
          context: get-build-info/docker
      - name: Tag commit
        uses: silphid/actions/tag-commit@v1
        with:
          tag: ${{ steps.info.outputs.git-tag }}
      - name: Set git identity
        run: |-
            git config --global user.email "nestobot@nesto.ca"
            git config --global user.name "nestobot"
      - name: Promote image in action
        id: promote
        uses: silphid/actions/replace-in-repo@master
        with:
          message: "Promote image in get-build-info action.yaml to: ${{ steps.info.output.docker-tag }}"
          glob: "get-build-info/action.yaml"
          search: "(?:image: docker://northamerica-northeast1-docker\\.pkg\\.dev/nesto-ci-78a3f2e6/actions/get-build-info:)\\d+.\\d+.\\d+"
          replace: ${{ steps.info.output.docker-tag }}
